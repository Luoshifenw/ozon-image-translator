# 项目进度文档

> 更新时间: 2024-12-21 21:30
> **状态**: ✅ 生产环境已部署 | 🚀 异步架构已上线 | 🟢 真实 API 正常运行

## 一、项目概述

**项目名称**: 图片批量翻译工具 v0.0.3 (Async Edition)
**目标用户**: Ozon 跨境电商卖家
**核心功能**: 批量上传商品图片 → **异步任务队列处理** → 实时轮询状态 → 预览与下载
**部署架构**: 阿里云香港轻量服务器 + Docker Compose + Nginx + Gunicorn

---

## 二、已完成工作 ✅

### 2.1 后端开发 (FastAPI)

| 模块             | 文件                               | 状态    | 说明                                                                           |
| :--------------- | :--------------------------------- | :------ | :----------------------------------------------------------------------------- |
| **异步任务管理** | `backend/services/task_manager.py` | ✅ 新增 | 核心组件。实现任务创建、状态跟踪、后台执行解耦                                 |
| **异步接口**     | `backend/routers/translate.py`     | ✅ 更新 | 新增 `/api/translate-bulk-async` (提交) 和 `/api/task-status/{task_id}` (轮询) |
| **翻译服务**     | `backend/services/translation.py`  | ✅ 完成 | 接入 APIMart GPT-4o-image，实现 Base64/URL 模式切换                            |
| **并发控制**     | `backend/config.py`                | ✅ 完成 | `asyncio.Semaphore` 限制 5 并发，随机延迟防止限流                              |
| **文件处理**     | `backend/services/file_handler.py` | ✅ 完成 | 本地临时存储，UUID 文件名防冲突                                                |

**核心改进**:

- **彻底解决 502 超时**: 放弃长连接等待，采用 "提交 + 轮询" 的异步架构，绕过 Nginx/云厂商的连接超时限制。
- **稳定性**: 后台任务独立运行，即使前端断开连接，翻译任务也会继续执行。

### 2.2 前端开发 (React + Vite + TypeScript)

| 模块             | 文件                                     | 状态    | 说明                                                 |
| :--------------- | :--------------------------------------- | :------ | :--------------------------------------------------- |
| **异步轮询逻辑** | `frontend/src/App.tsx`                   | ✅ 重构 | 替换原有 Axios 等待逻辑，实现每 2 秒轮询任务状态     |
| **状态管理**     | `frontend/src/App.tsx`                   | ✅ 优化 | 处理 Uploading -> Processing -> Completed 的状态流转 |
| **上传组件**     | `frontend/src/components/UploadZone.tsx` | ✅ 完成 | 支持多图拖拽，实时预览                               |
| **结果展示**     | `frontend/src/App.tsx`                   | ✅ 完成 | 翻译结果网格预览，支持单张/批量下载                  |

### 2.3 运维与部署 (DevOps)

| 文件/脚本          | 状态    | 说明                                          |
| :----------------- | :------ | :-------------------------------------------- |
| `deploy.sh`        | ✅ 新增 | 一键自动化部署脚本 (Git Pull -> Build -> Up)  |
| `get-logs.sh`      | ✅ 新增 | 远程日志获取工具                              |
| `nginx.conf`       | ✅ 优化 | 配置反向代理，静态资源缓存，API 转发          |
| `gunicorn.conf.py` | ✅ 新增 | 生产级 WSGI/ASGI 服务器配置，优化 Worker 设置 |

---

## 三、项目现状分析

### 3.1 核心优势

1.  **高可用性**: 异步架构使得系统不再受限于 HTTP 请求超时（60s/300s），理论上可处理任意耗时的批量任务。
2.  **真实效果**: 验证了 "参考图 + Prompt" 模式在 GPT-4o-image API 上的翻译效果，解决了"生成图无关"的问题。
3.  **极速部署**: 建立了完整的 CI/CD 雏形（通过脚本），更新代码只需几秒钟。

### 3.2 存在不足 (Shortcomings)

1.  **安全性缺失**: 目前服务完全公开，无鉴权机制。由于调用的是付费 API，面临被盗刷的风险。
2.  **数据持久化**: 依赖服务器本地 `/tmp` 目录，重启容器或服务器故障可能导致未下载的文件丢失。
3.  **错误反馈粒度**: 如果单张图片翻译失败，前端目前只显示"部分失败"，缺乏具体哪一张失败的直观提示。
4.  **资源隔离**: 所有用户共享同一个后端并发队列，高并发下可能出现任务堆积。

---

## 四、后续优化计划 (Roadmap) 🚀

### 4.1 紧急优化 (P0 - 立即执行)

| 任务                      | 说明                                                          | 目的                    |
| :------------------------ | :------------------------------------------------------------ | :---------------------- |
| **基础鉴权 (Basic Auth)** | 在 Nginx 或 FastAPI 层添加简单的密码/Token 验证               | 防止 API Key 被外部盗刷 |
| **自动清理增强**          | 完善 Cron 机制，确保 `/tmp` 下的过期文件（>1 小时）被绝对清理 | 防止服务器磁盘写满      |

### 4.2 功能完善 (P1 - 体验升级)

| 任务             | 说明                                                  | 目的                   |
| :--------------- | :---------------------------------------------------- | :--------------------- |
| **详细进度条**   | 轮询接口返回 `processed_count` / `total_count`        | 让用户知道还需要等多久 |
| **失败重试机制** | 针对 API 偶尔的 500/Timeout 错误，增加 1-2 次自动重试 | 提高任务成功率         |
| **图片压缩**     | 上传前或下载前对图片进行压缩                          | 节省带宽，加快传输速度 |

### 4.3 架构演进 (P2 - 长期规划)

| 任务                    | 说明                                  | 目的                           |
| :---------------------- | :------------------------------------ | :----------------------------- |
| **云存储集成 (OSS/S3)** | 将图片存入阿里云 OSS 而非本地文件系统 | 彻底实现无状态化，便于横向扩展 |
| **用户账户系统**        | 注册/登录，API Usage 统计             | 商业化基础                     |
| **多语言支持**          | 界面与翻译目标语言可配置              | 拓展到其他市场                 |

---

## 五、技术复盘：502 Bad Gateway 攻坚战

### 问题现象

前端上传图片后，等待约 30-60 秒，Nginx 返回 `502 Bad Gateway`。

### 排查过程

1.  **调整超时**: 修改 Nginx `proxy_read_timeout` 至 300s，无效。
2.  **后端调整**: 修改 Gunicorn/Uvicorn `timeout` 至 300s，无效。
3.  **链路分析**: 发现后端任务实际在 70-100s 完成，但前端连接在 60s 左右被切断。
4.  **根因定位**: 阿里云负载均衡或基础网络层（或 Docker 网络）存在默认的连接存活时间限制，单纯调整应用层超时无法突破物理/网络层的限制。

### 解决方案

**架构重构**: 从同步等待 (`Synchronous Wait`) 转向 异步轮询 (`Asynchronous Polling`)。

- **Before**: Request -> Wait (60s+) -> Response (Timeout/Error)
- **After**: Request -> TaskID (Immediate) -> Poll TaskID (Every 2s) -> Result

---

如有新的需求，请更新此文档。

---

## 2025-09-27 工作进度（账户/支付体系升级）

### 已完成 ✅

| 模块 | 文件 | 状态 | 说明 |
| :--- | :--- | :--- | :--- |
| **SQLite + SQLModel** | `backend/models/db_models.py` | ✅ 新增 | 新建 Users/Orders 数据模型，替代原 JSON 存储 |
| **数据库初始化** | `backend/services/db.py` `backend/main.py` | ✅ 完成 | 启动时创建表并初始化连接 |
| **JWT 认证** | `backend/services/security.py` `backend/routers/auth.py` | ✅ 完成 | 注册/登录、JWT 发行与校验、余额查询 |
| **积分扣费** | `backend/routers/translate.py` | ✅ 完成 | 翻译前校验余额并扣除积分 |
| **ZPay 支付** | `backend/routers/payments.py` | ✅ 新增 | 创建订单、MD5 签名校验、回调自动加分 |
| **前端登录/注册** | `frontend/src/components/LoginModal.tsx` | ✅ 完成 | Tab 切换登录/注册，邀请码逻辑接入 |
| **充值弹窗** | `frontend/src/components/RechargeModal.tsx` | ✅ 新增 | 展示三档套餐并拉起支付 |
| **控制台余额展示** | `frontend/src/App.tsx` | ✅ 完成 | 实时余额 + 充值按钮 |

### 当前阶段完成情况（用户确认）✅

- 用户系统：注册、登录、积分管理（注册/试用送积分）已上线并验证通过
- 前端界面：新的登录弹窗、充值弹窗界面已实装
- 数据库：SQLite 迁移完成，数据读写正常

### 配置与依赖更新

- `backend/requirements.txt`：新增 SQLModel、JWT、bcrypt、email 校验依赖
- `backend/config.py`：新增 `DB_PATH`、`JWT_SECRET`、`INVITE_CODES`、`ZPAY_*` 等配置项

### 待确认/后续事项

- 填写并校验 `ZPAY_PID`、`ZPAY_KEY`、`ZPAY_NOTIFY_URL`、`ZPAY_RETURN_URL`
- 运行后端依赖安装并启动服务，验证注册/登录/扣费/支付回调全链路

### 当前阻塞问题（Blocker）

- 支付签名失败：已修复 `&key=` 前缀问题并补全 `sitename` 参数，但 ZPay 仍返回 MD5 签名错误（参考 `pay.txt` 官方 demo）

### 下一步操作清单（按优先级）

1. 配置后端环境变量（`backend/.env`）：`JWT_SECRET`、`INVITE_CODES`、`ZPAY_PID`、`ZPAY_KEY`、`ZPAY_NOTIFY_URL`、`ZPAY_RETURN_URL`、`BASE_URL`
2. 安装后端依赖并启动服务，确认能自动创建 SQLite 数据库（检查 `backend/data/app.db`）
3. 手动验证注册/登录/余额接口：`/api/auth/register`、`/api/auth/token`、`/api/auth/quota`
4. 验证翻译扣费：上传多张图后确认余额减少是否正确
5. 配置 ZPay 回调地址并做一次真实支付回调测试，确认自动加分
