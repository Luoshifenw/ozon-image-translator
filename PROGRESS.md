# é¡¹ç›®è¿›åº¦æ–‡æ¡£

> æ›´æ–°æ—¶é—´: 2024-12-21 21:30
> **çŠ¶æ€**: âœ… ç”Ÿäº§çŽ¯å¢ƒå·²éƒ¨ç½² | ðŸš€ å¼‚æ­¥æž¶æž„å·²ä¸Šçº¿ | ðŸŸ¢ çœŸå®ž API æ­£å¸¸è¿è¡Œ

## ä¸€ã€é¡¹ç›®æ¦‚è¿°

**é¡¹ç›®åç§°**: å›¾ç‰‡æ‰¹é‡ç¿»è¯‘å·¥å…· v0.0.3 (Async Edition)
**ç›®æ ‡ç”¨æˆ·**: Ozon è·¨å¢ƒç”µå•†å–å®¶
**æ ¸å¿ƒåŠŸèƒ½**: æ‰¹é‡ä¸Šä¼ å•†å“å›¾ç‰‡ â†’ **å¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—å¤„ç†** â†’ å®žæ—¶è½®è¯¢çŠ¶æ€ â†’ é¢„è§ˆä¸Žä¸‹è½½
**éƒ¨ç½²æž¶æž„**: é˜¿é‡Œäº‘é¦™æ¸¯è½»é‡æœåŠ¡å™¨ + Docker Compose + Nginx + Gunicorn

---

## äºŒã€å·²å®Œæˆå·¥ä½œ âœ…

### 2.1 åŽç«¯å¼€å‘ (FastAPI)

| æ¨¡å—             | æ–‡ä»¶                               | çŠ¶æ€    | è¯´æ˜Ž                                                                           |
| :--------------- | :--------------------------------- | :------ | :----------------------------------------------------------------------------- |
| **å¼‚æ­¥ä»»åŠ¡ç®¡ç†** | `backend/services/task_manager.py` | âœ… æ–°å¢ž | æ ¸å¿ƒç»„ä»¶ã€‚å®žçŽ°ä»»åŠ¡åˆ›å»ºã€çŠ¶æ€è·Ÿè¸ªã€åŽå°æ‰§è¡Œè§£è€¦                                 |
| **å¼‚æ­¥æŽ¥å£**     | `backend/routers/translate.py`     | âœ… æ›´æ–° | æ–°å¢ž `/api/translate-bulk-async` (æäº¤) å’Œ `/api/task-status/{task_id}` (è½®è¯¢) |
| **ç¿»è¯‘æœåŠ¡**     | `backend/services/translation.py`  | âœ… å®Œæˆ | æŽ¥å…¥ APIMart GPT-4o-imageï¼Œå®žçŽ° Base64/URL æ¨¡å¼åˆ‡æ¢                            |
| **å¹¶å‘æŽ§åˆ¶**     | `backend/config.py`                | âœ… å®Œæˆ | `asyncio.Semaphore` é™åˆ¶ 5 å¹¶å‘ï¼Œéšæœºå»¶è¿Ÿé˜²æ­¢é™æµ                              |
| **æ–‡ä»¶å¤„ç†**     | `backend/services/file_handler.py` | âœ… å®Œæˆ | æœ¬åœ°ä¸´æ—¶å­˜å‚¨ï¼ŒUUID æ–‡ä»¶åé˜²å†²çª                                                |

**æ ¸å¿ƒæ”¹è¿›**:

- **å½»åº•è§£å†³ 502 è¶…æ—¶**: æ”¾å¼ƒé•¿è¿žæŽ¥ç­‰å¾…ï¼Œé‡‡ç”¨ "æäº¤ + è½®è¯¢" çš„å¼‚æ­¥æž¶æž„ï¼Œç»•è¿‡ Nginx/äº‘åŽ‚å•†çš„è¿žæŽ¥è¶…æ—¶é™åˆ¶ã€‚
- **ç¨³å®šæ€§**: åŽå°ä»»åŠ¡ç‹¬ç«‹è¿è¡Œï¼Œå³ä½¿å‰ç«¯æ–­å¼€è¿žæŽ¥ï¼Œç¿»è¯‘ä»»åŠ¡ä¹Ÿä¼šç»§ç»­æ‰§è¡Œã€‚

### 2.2 å‰ç«¯å¼€å‘ (React + Vite + TypeScript)

| æ¨¡å—             | æ–‡ä»¶                                     | çŠ¶æ€    | è¯´æ˜Ž                                                 |
| :--------------- | :--------------------------------------- | :------ | :--------------------------------------------------- |
| **å¼‚æ­¥è½®è¯¢é€»è¾‘** | `frontend/src/App.tsx`                   | âœ… é‡æž„ | æ›¿æ¢åŽŸæœ‰ Axios ç­‰å¾…é€»è¾‘ï¼Œå®žçŽ°æ¯ 2 ç§’è½®è¯¢ä»»åŠ¡çŠ¶æ€     |
| **çŠ¶æ€ç®¡ç†**     | `frontend/src/App.tsx`                   | âœ… ä¼˜åŒ– | å¤„ç† Uploading -> Processing -> Completed çš„çŠ¶æ€æµè½¬ |
| **ä¸Šä¼ ç»„ä»¶**     | `frontend/src/components/UploadZone.tsx` | âœ… å®Œæˆ | æ”¯æŒå¤šå›¾æ‹–æ‹½ï¼Œå®žæ—¶é¢„è§ˆ                               |
| **ç»“æžœå±•ç¤º**     | `frontend/src/App.tsx`                   | âœ… å®Œæˆ | ç¿»è¯‘ç»“æžœç½‘æ ¼é¢„è§ˆï¼Œæ”¯æŒå•å¼ /æ‰¹é‡ä¸‹è½½                  |

### 2.3 è¿ç»´ä¸Žéƒ¨ç½² (DevOps)

| æ–‡ä»¶/è„šæœ¬          | çŠ¶æ€    | è¯´æ˜Ž                                          |
| :----------------- | :------ | :-------------------------------------------- |
| `deploy.sh`        | âœ… æ–°å¢ž | ä¸€é”®è‡ªåŠ¨åŒ–éƒ¨ç½²è„šæœ¬ (Git Pull -> Build -> Up)  |
| `get-logs.sh`      | âœ… æ–°å¢ž | è¿œç¨‹æ—¥å¿—èŽ·å–å·¥å…·                              |
| `nginx.conf`       | âœ… ä¼˜åŒ– | é…ç½®åå‘ä»£ç†ï¼Œé™æ€èµ„æºç¼“å­˜ï¼ŒAPI è½¬å‘          |
| `gunicorn.conf.py` | âœ… æ–°å¢ž | ç”Ÿäº§çº§ WSGI/ASGI æœåŠ¡å™¨é…ç½®ï¼Œä¼˜åŒ– Worker è®¾ç½® |

---

## ä¸‰ã€é¡¹ç›®çŽ°çŠ¶åˆ†æž

### 3.1 æ ¸å¿ƒä¼˜åŠ¿

1.  **é«˜å¯ç”¨æ€§**: å¼‚æ­¥æž¶æž„ä½¿å¾—ç³»ç»Ÿä¸å†å—é™äºŽ HTTP è¯·æ±‚è¶…æ—¶ï¼ˆ60s/300sï¼‰ï¼Œç†è®ºä¸Šå¯å¤„ç†ä»»æ„è€—æ—¶çš„æ‰¹é‡ä»»åŠ¡ã€‚
2.  **çœŸå®žæ•ˆæžœ**: éªŒè¯äº† "å‚è€ƒå›¾ + Prompt" æ¨¡å¼åœ¨ GPT-4o-image API ä¸Šçš„ç¿»è¯‘æ•ˆæžœï¼Œè§£å†³äº†"ç”Ÿæˆå›¾æ— å…³"çš„é—®é¢˜ã€‚
3.  **æžé€Ÿéƒ¨ç½²**: å»ºç«‹äº†å®Œæ•´çš„ CI/CD é›å½¢ï¼ˆé€šè¿‡è„šæœ¬ï¼‰ï¼Œæ›´æ–°ä»£ç åªéœ€å‡ ç§’é’Ÿã€‚

### 3.2 å­˜åœ¨ä¸è¶³ (Shortcomings)

1.  **å®‰å…¨æ€§ç¼ºå¤±**: ç›®å‰æœåŠ¡å®Œå…¨å…¬å¼€ï¼Œæ— é‰´æƒæœºåˆ¶ã€‚ç”±äºŽè°ƒç”¨çš„æ˜¯ä»˜è´¹ APIï¼Œé¢ä¸´è¢«ç›—åˆ·çš„é£Žé™©ã€‚
2.  **æ•°æ®æŒä¹…åŒ–**: ä¾èµ–æœåŠ¡å™¨æœ¬åœ° `/tmp` ç›®å½•ï¼Œé‡å¯å®¹å™¨æˆ–æœåŠ¡å™¨æ•…éšœå¯èƒ½å¯¼è‡´æœªä¸‹è½½çš„æ–‡ä»¶ä¸¢å¤±ã€‚
3.  **é”™è¯¯åé¦ˆç²’åº¦**: å¦‚æžœå•å¼ å›¾ç‰‡ç¿»è¯‘å¤±è´¥ï¼Œå‰ç«¯ç›®å‰åªæ˜¾ç¤º"éƒ¨åˆ†å¤±è´¥"ï¼Œç¼ºä¹å…·ä½“å“ªä¸€å¼ å¤±è´¥çš„ç›´è§‚æç¤ºã€‚
4.  **èµ„æºéš”ç¦»**: æ‰€æœ‰ç”¨æˆ·å…±äº«åŒä¸€ä¸ªåŽç«¯å¹¶å‘é˜Ÿåˆ—ï¼Œé«˜å¹¶å‘ä¸‹å¯èƒ½å‡ºçŽ°ä»»åŠ¡å †ç§¯ã€‚

---

## å››ã€åŽç»­ä¼˜åŒ–è®¡åˆ’ (Roadmap) ðŸš€

### 4.1 ç´§æ€¥ä¼˜åŒ– (P0 - ç«‹å³æ‰§è¡Œ)

| ä»»åŠ¡                      | è¯´æ˜Ž                                                          | ç›®çš„                    |
| :------------------------ | :------------------------------------------------------------ | :---------------------- |
| **åŸºç¡€é‰´æƒ (Basic Auth)** | åœ¨ Nginx æˆ– FastAPI å±‚æ·»åŠ ç®€å•çš„å¯†ç /Token éªŒè¯               | é˜²æ­¢ API Key è¢«å¤–éƒ¨ç›—åˆ· |
| **è‡ªåŠ¨æ¸…ç†å¢žå¼º**          | å®Œå–„ Cron æœºåˆ¶ï¼Œç¡®ä¿ `/tmp` ä¸‹çš„è¿‡æœŸæ–‡ä»¶ï¼ˆ>1 å°æ—¶ï¼‰è¢«ç»å¯¹æ¸…ç† | é˜²æ­¢æœåŠ¡å™¨ç£ç›˜å†™æ»¡      |

### 4.2 åŠŸèƒ½å®Œå–„ (P1 - ä½“éªŒå‡çº§)

| ä»»åŠ¡             | è¯´æ˜Ž                                                  | ç›®çš„                   |
| :--------------- | :---------------------------------------------------- | :--------------------- |
| **è¯¦ç»†è¿›åº¦æ¡**   | è½®è¯¢æŽ¥å£è¿”å›ž `processed_count` / `total_count`        | è®©ç”¨æˆ·çŸ¥é“è¿˜éœ€è¦ç­‰å¤šä¹… |
| **å¤±è´¥é‡è¯•æœºåˆ¶** | é’ˆå¯¹ API å¶å°”çš„ 500/Timeout é”™è¯¯ï¼Œå¢žåŠ  1-2 æ¬¡è‡ªåŠ¨é‡è¯• | æé«˜ä»»åŠ¡æˆåŠŸçŽ‡         |
| **å›¾ç‰‡åŽ‹ç¼©**     | ä¸Šä¼ å‰æˆ–ä¸‹è½½å‰å¯¹å›¾ç‰‡è¿›è¡ŒåŽ‹ç¼©                          | èŠ‚çœå¸¦å®½ï¼ŒåŠ å¿«ä¼ è¾“é€Ÿåº¦ |

### 4.3 æž¶æž„æ¼”è¿› (P2 - é•¿æœŸè§„åˆ’)

| ä»»åŠ¡                    | è¯´æ˜Ž                                  | ç›®çš„                           |
| :---------------------- | :------------------------------------ | :----------------------------- |
| **äº‘å­˜å‚¨é›†æˆ (OSS/S3)** | å°†å›¾ç‰‡å­˜å…¥é˜¿é‡Œäº‘ OSS è€Œéžæœ¬åœ°æ–‡ä»¶ç³»ç»Ÿ | å½»åº•å®žçŽ°æ— çŠ¶æ€åŒ–ï¼Œä¾¿äºŽæ¨ªå‘æ‰©å±• |
| **ç”¨æˆ·è´¦æˆ·ç³»ç»Ÿ**        | æ³¨å†Œ/ç™»å½•ï¼ŒAPI Usage ç»Ÿè®¡             | å•†ä¸šåŒ–åŸºç¡€                     |
| **å¤šè¯­è¨€æ”¯æŒ**          | ç•Œé¢ä¸Žç¿»è¯‘ç›®æ ‡è¯­è¨€å¯é…ç½®              | æ‹“å±•åˆ°å…¶ä»–å¸‚åœº                 |

---

## äº”ã€æŠ€æœ¯å¤ç›˜ï¼š502 Bad Gateway æ”»åšæˆ˜

### é—®é¢˜çŽ°è±¡

å‰ç«¯ä¸Šä¼ å›¾ç‰‡åŽï¼Œç­‰å¾…çº¦ 30-60 ç§’ï¼ŒNginx è¿”å›ž `502 Bad Gateway`ã€‚

### æŽ’æŸ¥è¿‡ç¨‹

1.  **è°ƒæ•´è¶…æ—¶**: ä¿®æ”¹ Nginx `proxy_read_timeout` è‡³ 300sï¼Œæ— æ•ˆã€‚
2.  **åŽç«¯è°ƒæ•´**: ä¿®æ”¹ Gunicorn/Uvicorn `timeout` è‡³ 300sï¼Œæ— æ•ˆã€‚
3.  **é“¾è·¯åˆ†æž**: å‘çŽ°åŽç«¯ä»»åŠ¡å®žé™…åœ¨ 70-100s å®Œæˆï¼Œä½†å‰ç«¯è¿žæŽ¥åœ¨ 60s å·¦å³è¢«åˆ‡æ–­ã€‚
4.  **æ ¹å› å®šä½**: é˜¿é‡Œäº‘è´Ÿè½½å‡è¡¡æˆ–åŸºç¡€ç½‘ç»œå±‚ï¼ˆæˆ– Docker ç½‘ç»œï¼‰å­˜åœ¨é»˜è®¤çš„è¿žæŽ¥å­˜æ´»æ—¶é—´é™åˆ¶ï¼Œå•çº¯è°ƒæ•´åº”ç”¨å±‚è¶…æ—¶æ— æ³•çªç ´ç‰©ç†/ç½‘ç»œå±‚çš„é™åˆ¶ã€‚

### è§£å†³æ–¹æ¡ˆ

**æž¶æž„é‡æž„**: ä»ŽåŒæ­¥ç­‰å¾… (`Synchronous Wait`) è½¬å‘ å¼‚æ­¥è½®è¯¢ (`Asynchronous Polling`)ã€‚

- **Before**: Request -> Wait (60s+) -> Response (Timeout/Error)
- **After**: Request -> TaskID (Immediate) -> Poll TaskID (Every 2s) -> Result

---

å¦‚æœ‰æ–°çš„éœ€æ±‚ï¼Œè¯·æ›´æ–°æ­¤æ–‡æ¡£ã€‚
